<script type="text/javascript">
    (function () {
        //  Run validateToken once at initial load
        require([
            'jquery',
            'CyberSource_SecureAcceptance/js/action/microform/validate-token'
        ], function ($, validateToken) {
            $(document).ready(function () {
                validateToken();
            });
        });

        // Watch for payment step and stop loader if microform is missing
        let lastHash = location.hash;
        function stopLoaderHard() {
            var paymentContent = document.querySelector('#checkout-step-payment');
            var hasMicroform = paymentContent && paymentContent.querySelector('[data-bind*="cybersource_microform"]');

            if (!hasMicroform) {
                require([
                    'Magento_Checkout/js/model/full-screen-loader',
                    'Magento_Ui/js/model/messageList'
                ], function (fullScreenLoader, messageList) {
                    fullScreenLoader.stopLoader();
                    // Remove loader overlay if still stuck
                    setTimeout(function () {
                        var mask = document.querySelector('.loading-mask');
                        if (mask) {
                            mask.style.display = 'none';
                            document.body.classList.remove('_has-loader');
                        } else {
                        }
                    }, 300);
                });
            }
        }
        window.addEventListener('hashchange', function () {
            if (location.hash === '#payment' && lastHash !== '#payment') {
                setTimeout(stopLoaderHard, 2000); // delay for Knockout render
            }
            lastHash = location.hash;
        });
    })();
</script>
